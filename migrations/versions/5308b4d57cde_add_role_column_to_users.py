"""add_role_column_to_users

Revision ID: 5308b4d57cde
Revises: b0afe86a69c1
Create Date: 2025-06-22 12:25:00.000000

"""

import sqlalchemy as sa
from alembic import op
from sqlalchemy import inspect

# revision identifiers, used by Alembic.
revision = "5308b4d57cde"
down_revision = "b0afe86a69c1"
branch_labels = None
depends_on = None


def upgrade() -> None:
    """–î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–æ–ª–±–µ—Ü role –≤ —Ç–∞–±–ª–∏—Ü—É users –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç."""

    # –ü–æ–ª—É—á–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä
    connection = op.get_bind()
    inspector = inspect(connection)

    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–æ–ª–±—Ü—ã
        columns = [c["name"] for c in inspector.get_columns("users")]

        if "role" not in columns:
            print("üîß –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç–æ–ª–±–µ—Ü role –≤ —Ç–∞–±–ª–∏—Ü—É users...")
            op.add_column("users", sa.Column("role", sa.String(50), nullable=True, default="user"))
            print("‚úÖ –°—Ç–æ–ª–±–µ—Ü role —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω")
        else:
            print("‚ö†Ô∏è –°—Ç–æ–ª–±–µ—Ü role —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Ç–∞–±–ª–∏—Ü–µ users")

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Å—Ç–æ–ª–±—Ü–∞ role: {e}")
        raise


def downgrade() -> None:
    """–£–¥–∞–ª—è–µ–º —Å—Ç–æ–ª–±–µ—Ü role –∏–∑ —Ç–∞–±–ª–∏—Ü—ã users."""

    # –ü–æ–ª—É—á–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∏ –∏–Ω—Å–ø–µ–∫—Ç–æ—Ä
    connection = op.get_bind()
    inspector = inspect(connection)

    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Å—Ç–æ–ª–±—Ü—ã
        columns = [c["name"] for c in inspector.get_columns("users")]

        if "role" in columns:
            print("üîß –£–¥–∞–ª—è–µ–º —Å—Ç–æ–ª–±–µ—Ü role –∏–∑ —Ç–∞–±–ª–∏—Ü—ã users...")
            op.drop_column("users", "role")
            print("‚úÖ –°—Ç–æ–ª–±–µ—Ü role —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω")
        else:
            print("‚ö†Ô∏è –°—Ç–æ–ª–±–µ—Ü role –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ç–∞–±–ª–∏—Ü–µ users")

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å—Ç–æ–ª–±—Ü–∞ role: {e}")
        raise
