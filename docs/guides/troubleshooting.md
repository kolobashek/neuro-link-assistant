# Устранение неполадок

В этом руководстве описаны типичные проблемы, с которыми вы можете столкнуться при разработке Neuro-Link Assistant, и способы их решения.

## Проблемы с установкой и настройкой

### Poetry не устанавливает зависимости

**Симптом**: При выполнении `poetry install` возникают ошибки разрешения зависимостей.

**Решение**:
```bash
# Обновите Poetry
poetry self update

# Очистите кэш
poetry cache clear --all .

# Обновите файл блокировки
poetry lock --no-update

# Попробуйте установить снова
poetry install
```

### Проблемы с Docker

**Симптом**: Контейнеры не запускаются или базы данных недоступны.

**Решение**:
```bash
# Проверьте статус контейнеров
docker-compose ps

# Перезапустите контейнеры
docker-compose down
docker-compose up -d

# Просмотрите логи
docker-compose logs
```

### Проблемы с Windows-зависимостями

**Симптом**: Ошибки импорта модулей Win32API, pywin32 или WMI.

**Решение**:
```bash
# Установите необходимые пакеты вручную
pip install pywin32==301
pip install WMI==1.5.1

# Проверьте установку
python -c "import win32api; print('Win32API OK')"
```

## Проблемы с запуском тестов

### Тесты не проходят из-за отсутствия компонентов

**Симптом**: Системные тесты не проходят с ошибками о неинициализированных компонентах.

**Решение**:
1. Проверьте, что все необходимые компоненты зарегистрированы в `SystemInitializer`
2. Убедитесь, что реестр компонентов правильно инициализирован
3. Проверьте, что все зависимости установлены

```python
# Пример отладки регистрации компонентов
def debug_component_registry(registry):
    print("Registered components:")
    for name in registry._components:
        print(f"- {name}")
```

### Тесты падают с ошибками доступа

**Симптом**: Тесты, связанные с файловой системой или вводом, падают с ошибками доступа.

**Решение**:
1. Запустите тесты с правами администратора
2. Используйте моки для изоляции тестов от реальной файловой системы:

```python
@pytest.fixture
def mock_filesystem():
    fs = MagicMock()
    fs.file_exists.return_value = True
    fs.read_file.return_value = "test content"
    return fs
```

## Проблемы с конкретными подсистемами

### Файловая система

**Симптом**: Ошибки при работе с файлами или путями.

**Решение**:
1. Проверьте права доступа к файлам и директориям
2. Используйте абсолютные пути вместо относительных
3. Обрабатывайте специальные символы в путях:

```python
import os
from pathlib import Path

# Используйте Path для кроссплатформенных путей
file_path = Path("some/directory") / "filename.txt"
absolute_path = file_path.absolute()
```

### Подсистема ввода

**Симптом**: Эмуляция клавиатуры или мыши не работает.

**Решение**:
1. Проверьте, запущено ли приложение с правами администратора
2. Убедитесь, что целевое окно в фокусе перед вводом
3. Добавьте задержки между действиями:

```python
import time

keyboard.press_key("a")
time.sleep(0.1)  # Небольшая задержка
keyboard.press_key("b")
```

### Подсистема компьютерного зрения

**Симптом**: Не удается обнаружить или распознать элементы на экране.

**Решение**:
1. Сохраните снимок экрана для диагностики:
   ```python
   screen_capture.save_screenshot("debug_screenshot.png")
   ```
2. Проверьте разрешение экрана и масштабирование
3. Увеличьте порог уверенности при распознавании:
   ```python
   element = vision.find_element(template, confidence=0.7)  # Попробуйте снизить порог
   ```

## Инструменты диагностики

### Логирование

Используйте встроенный обработчик ошибок для логирования:

```python
from core.common.error_handler import handle_error

try:
    # Код, который может вызвать ошибку
    result = some_operation()
except Exception as e:
    handle_error(e, "Ошибка при выполнении операции", module="my_module")
```

Логи сохраняются в директории `logs/`.

### Отладочный режим

Включите отладочный режим для более подробного вывода:

```bash
# Запуск с отладочной информацией
pytest -v --log-cli-level=DEBUG tests/system/
```

## Сообщение о проблемах

Если вы столкнулись с проблемой, которую не удается решить:

1. Соберите всю диагностическую информацию:
   - Полный текст ошибки
   - Логи приложения
   - Шаги для воспроизведения
   - Версии используемых компонентов

2. Создайте issue на GitHub с подробным описанием:
   - Используйте шаблон для сообщения о проблеме
   - Приложите собранную информацию
   - Укажите ожидаемое и фактическое поведение
