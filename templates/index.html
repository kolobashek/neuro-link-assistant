{% extends "base.html" %}
{% block title %}–ù–µ–π—Ä–æ –ê—Å—Å–∏—Å—Ç–µ–Ω—Ç{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/command_form.css') }}" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/ai_models.css') }}" />
<link rel="stylesheet" href="{{ url_for('static', filename='css/history.css') }}" />
{% endblock %}

{% block content %}
<div class="dashboard-layout">
	<!-- –°—Ç–∞—Ç—É—Å –ø–∞–Ω–µ–ª—å -->
	<section class="dashboard-status">
		{% include "components/dashboard_status.html" %}
	</section>

	<!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å - –±—ã—Å—Ç—Ä—ã–π —á–∞—Ç -->
	<section class="dashboard-main">
		{% include "components/quick_chat.html" %}
	</section>

	<!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å - –ø–æ—Å–ª–µ–¥–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è -->
	<aside class="dashboard-sidebar">
		{% include "components/recent_activities.html" %}
	</aside>
</div>

<!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
<div class="quick-actions">
	<h3>üöÄ –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
	<div class="action-buttons">
		<a href="/models" class="btn btn-primary">ü§ñ AI –ú–æ–¥–µ–ª–∏</a>
		<a href="/tasks" class="btn btn-secondary">üìã –ó–∞–¥–∞—á–∏</a>
		<a href="/history" class="btn btn-info">üìö –ò—Å—Ç–æ—Ä–∏—è</a>
		<button class="btn btn-success" data-modal-open="aiTestModal">
			üß† –¢–µ—Å—Ç AI
		</button>
	</div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è AI (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ - —É–±—Ä–∞–Ω display: block) -->
<div id="aiTestModal" class="modal ai-test-modal">
	<div class="modal-content">
		<div class="modal-header">
			<h2>üß† –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç AI</h2>
			<button class="modal-close" data-modal-close="aiTestModal">
				<i class="fas fa-times"></i>
			</button>
		</div>

		<div class="modal-body">
			<!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–∫—É—â–µ–π –º–æ–¥–µ–ª–∏ -->
			<div class="current-model-info">
				<strong>ü§ñ –ê–∫—Ç–∏–≤–Ω–∞—è –º–æ–¥–µ–ª—å:</strong>
				<span id="testCurrentModel">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
			</div>

			<!-- –ë—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã -->
			<div class="quick-tests">
				<h3>üöÄ –ë—ã—Å—Ç—Ä—ã–µ —Ç–µ—Å—Ç—ã:</h3>
				<div class="test-buttons">
					<button class="btn btn-outline quick-test-btn" data-test="üëã –ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞?">
						üëã –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
					</button>
					<button class="btn btn-outline quick-test-btn" data-test="–°–∫–æ–ª—å–∫–æ –±—É–¥–µ—Ç 15 * 7 + 23?">
						üßÆ –ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞
					</button>
					<button class="btn btn-outline quick-test-btn" data-test="–†–∞—Å—Å–∫–∞–∂–∏ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–π —Ñ–∞–∫—Ç –æ –∫–æ—Å–º–æ—Å–µ">
						üß† –ó–Ω–∞–Ω–∏—è
					</button>
					<button class="btn btn-outline quick-test-btn" data-test="–ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫–æ–µ —Å—Ç–∏—Ö–æ—Ç–≤–æ—Ä–µ–Ω–∏–µ –æ –∫–æ—Ç–µ">
						‚ú® –¢–≤–æ—Ä—á–µ—Å—Ç–≤–æ
					</button>
				</div>
			</div>

			<!-- –§–æ—Ä–º–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
			<form id="aiTestForm">
				<div class="form-group">
					<label for="aiPrompt">üí¨ –ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π –∑–∞–ø—Ä–æ—Å:</label>
					<textarea id="aiPrompt" name="prompt" placeholder="–í–∞—à –≤–æ–ø—Ä–æ—Å –¥–ª—è AI..." required></textarea>
				</div>
				<button type="submit" class="btn btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç</button>
			</form>

			<!-- –†–µ–∑—É–ª—å—Ç–∞—Ç —Ç–µ—Å—Ç–∞ -->
			<div id="aiResponse" class="test-result" style="display: none;">
				<h3>–û—Ç–≤–µ—Ç AI:</h3>
				<div id="aiResponseText"></div>
				<div class="test-metrics">
					<span id="responseTime">‚è±Ô∏è –í—Ä–µ–º—è: 0–º—Å</span>
					<span id="tokenCount">üî¢ –¢–æ–∫–µ–Ω—ã: 0</span>
				</div>
			</div>
		</div>
	</div>
</div>

{% endblock %}

{% block extra_js %}
<!-- ‚ùå –£–î–ê–õ–ï–ù –î–£–ë–õ–ò–†–£–Æ–©–ò–ô–°–Ø main.js - —É–∂–µ –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –≤ base.html -->

<!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º dashboard.js –¥–ª—è –≥–ª–∞–≤–Ω–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
<script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>

<!-- –û—Å—Ç–∞–ª—å–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç—ã -->
<script src="{{ url_for('static', filename='js/utils.js') }}"></script>
<script src="{{ url_for('static', filename='js/fixes.js') }}"></script>

<script>
	document.addEventListener('DOMContentLoaded', function () {
		const aiTestForm = document.getElementById('aiTestForm');
		const aiPromptInput = document.getElementById('aiPrompt');
		const aiResponse = document.getElementById('aiResponse');
		const aiResponseText = document.getElementById('aiResponseText');
		const responseTime = document.getElementById('responseTime');
		const tokenCount = document.getElementById('tokenCount');

		// ‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–æ–∫ –±—ã—Å—Ç—Ä—ã—Ö —Ç–µ—Å—Ç–æ–≤
		document.addEventListener('click', function (e) {
			if (e.target.classList.contains('quick-test-btn')) {
				const testPrompt = e.target.getAttribute('data-test');
				if (testPrompt && aiPromptInput) {
					aiPromptInput.value = testPrompt;
					aiPromptInput.focus();

					// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç
					if (aiTestForm) {
						aiTestForm.dispatchEvent(new Event('submit'));
					}
				}
			}
		});

		// ‚úÖ –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Ñ–æ—Ä–º—ã —Å –æ—á–∏—Å—Ç–∫–æ–π –∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏
		if (aiTestForm) {
			aiTestForm.addEventListener('submit', async function (e) {
				e.preventDefault();

				const prompt = aiPromptInput.value.trim();
				if (!prompt) {
					alert('–í–≤–µ–¥–∏—Ç–µ –∑–∞–ø—Ä–æ—Å!');
					return;
				}

				const startTime = performance.now();

				try {
					// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
					if (aiResponseText) {
						aiResponseText.innerHTML = 'ü§ñ <em>–î—É–º–∞—é...</em>';
						aiResponse.style.display = 'block';
					}

					// –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –º–æ–¥–µ–ª—å
					updateCurrentModel();

					const response = await fetch('/api/ai/test', {
						method: 'POST',
						headers: { 'Content-Type': 'application/json' },
						body: JSON.stringify({ prompt })
					});

					const endTime = performance.now();
					const duration = Math.round(endTime - startTime);

					if (!response.ok) {
						throw new Error(`HTTP ${ response.status }: ${ response.statusText }`);
					}

					const data = await response.json();

					if (data.success && aiResponseText) {
						// ‚úÖ –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
						aiResponseText.innerHTML = `
						<div class="ai-response-content">
							<div class="response-text">${ data.response }</div>
							<div class="response-meta">
								<small>ü§ñ –ú–æ–¥–µ–ª—å: ${ data.model || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' }</small>
							</div>
						</div>
					`;

						// ‚úÖ –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç—Ä–∏–∫–∏
						if (responseTime) {
							responseTime.textContent = `‚è±Ô∏è –í—Ä–µ–º—è: ${ duration }–º—Å`;
						}
						if (tokenCount) {
							const estimatedTokens = Math.ceil((prompt.length + data.response.length) / 4);
							tokenCount.textContent = `üî¢ –¢–æ–∫–µ–Ω—ã: ${ estimatedTokens }`;
						}

						// ‚úÖ –û–ß–ò–©–ê–ï–ú –ü–û–õ–ï –í–í–û–î–ê
						aiPromptInput.value = '';

					} else {
						throw new Error(data.error || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞');
					}

				} catch (error) {
					console.error('‚ùå –û—à–∏–±–∫–∞ AI –∑–∞–ø—Ä–æ—Å–∞:', error);

					if (aiResponseText) {
						aiResponseText.innerHTML = `
						<div class="ai-response-error">
							‚ùå <strong>–û—à–∏–±–∫–∞:</strong> ${ error.message }
						</div>
					`;
					}

					if (responseTime) responseTime.textContent = `‚è±Ô∏è –í—Ä–µ–º—è: ${ Math.round(performance.now() - startTime) }–º—Å`;
					if (tokenCount) tokenCount.textContent = 'üî¢ –¢–æ–∫–µ–Ω—ã: 0';
				}
			});
		}

		// ‚úÖ –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π –º–æ–¥–µ–ª–∏
		function updateCurrentModel() {
			const currentModelEl = document.getElementById('current-model-name');
			if (currentModelEl) {
				currentModelEl.textContent = 'DistilGPT-2 Simple';
			}
		}
	});
</script>

<!-- ‚úÖ –°—Ç–∏–ª–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
<style>
	.quick-tests {
		margin-bottom: 1.5rem;
	}

	.test-buttons {
		display: grid;
		grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
		gap: 0.5rem;
		margin-top: 0.5rem;
	}

	.quick-test-btn {
		padding: 0.5rem;
		font-size: 0.9rem;
		text-align: center;
		transition: all 0.2s ease;
	}

	.quick-test-btn:hover {
		transform: translateY(-2px);
		box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
	}

	.test-result {
		margin-top: 1rem;
		padding: 1rem;
		background-color: #f8f9fa;
		border-radius: 8px;
		border-left: 4px solid #007bff;
	}

	.ai-response-content {
		margin-bottom: 0.5rem;
	}

	.response-text {
		font-size: 1rem;
		line-height: 1.5;
		margin-bottom: 0.5rem;
	}

	.response-meta {
		opacity: 0.7;
	}

	.ai-response-error {
		color: #dc3545;
		font-weight: 500;
	}

	.test-metrics {
		display: flex;
		gap: 1rem;
		margin-top: 0.5rem;
		font-size: 0.9rem;
		color: #6c757d;
	}

	@media (max-width: 768px) {
		.test-buttons {
			grid-template-columns: repeat(2, 1fr);
		}
	}
</style>
{% endblock %}
